var LIB_MINI_PROGRAM={VERSION:"1.0.1",NAME:"miniprogram"},CONFIG={autoRetry:3},ArrayProto=Array.prototype,FuncProto=Function.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,nativeBind=FuncProto.bind,nativeForEach=ArrayProto.forEach,nativeIsArray=Array.isArray,breaker={},key_error="error",key_warn="warn",key_info="info",key_gdt_pixel_error="GDT_Pixel_Error",key_gdt_pixel_warn="GDT_Pixel_Warning",_={trim:function(n){return n.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},each:function(n,t,e){if(null!==n&&void 0!==n)if(nativeForEach&&n.forEach===nativeForEach)n.forEach(t,e);else if(n.length===+n.length){for(var r=0,i=n.length;r<i;r++)if(r in n&&t.call(e,n[r],r,n)===breaker)return}else for(var o in n)if(hasOwnProperty.call(n,o)&&t.call(e,n[o],o,n)===breaker)return},has:function(n,t){return null!=n&&hasOwnProperty.call(n,t)},includes:function(n,t){return-1!==n.indexOf(t)},isUndefined:function(n){return void 0===n},isNull:function(n){return null===n}};_.isArray=nativeIsArray||function(n){return"[object Array]"==toString.call(n)},_.isArguments=function(n){return!(!n||!hasOwnProperty.call(n,"callee"))},_.isFunction=function(n){try{return/^\s*\bfunction\b/.test(n)}catch(n){return!1}},_.isObject=function(n){return n===Object(n)&&!_.isArray(n)},_.isString=function(n){return"[object String]"==toString.call(n)},_.isDate=function(n){return"[object Date]"==toString.call(n)},_.isNumber=function(n){return"[object Number]"==toString.call(n)},_.isBoolean=function(n){return!0===n||!1===n||"[object Boolean]"==toString.call(n)},_.isEmpty=function(n){if(_.isUndefined(n))return!0;if(null==n)return!0;if(_.isArray(n)||_.isString(n))return 0===n.length;for(var t in n)if(_.has(n,t))return!1;return!0},_.extend=function(n){return _.each(slice.call(arguments,1),function(t){for(var e in t)void 0!==t[e]&&(n[e]=t[e])}),n},_.keys=function(n){var t=[];return null===n?t:(_.each(n,function(n,e){t[t.length]=e}),t)},_.values=function(n){var t=[];return null===n?t:(_.each(n,function(n){t[t.length]=n}),t)},_.toArray=function(n){return n?n.toArray?n.toArray():_.isArray(n)?slice.call(n):_.isArguments(n)?slice.call(n):_.values(n):[]};var ctor=function(){};_.bind=function(n,t){var e,r;if(nativeBind&&n.bind===nativeBind)return nativeBind.apply(n,slice.call(arguments,1));if(!_.isFunction(n))throw new TypeError;return e=slice.call(arguments,2),r=function(){if(!(this instanceof r))return n.apply(t,e.concat(slice.call(arguments)));ctor.prototype=n.prototype;var i=new ctor;ctor.prototype=null;var o=n.apply(i,e.concat(slice.call(arguments)));return Object(o)===o?o:i}},_.getQueryParam=function(n,t){var e=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(n);return null===e||e&&"string"!=typeof e[1]&&e[1].length?"":decodeURIComponent(e[1]).replace(/\+/g," ")},_.HTTPBuildQuery=function(n,t){var e,r,i=[];return _.isUndefined(t)&&(t="&"),_.each(n,function(n,t){e=_.isArray(n)||_.isObject(n)?encodeURIComponent(_.JSONEncode(n)):encodeURIComponent(n.toString()),r=encodeURIComponent(t),i[i.length]=r+"="+e}),i.join(t)},_.listenOnce=function(n,t,e){n.addEventListener(t,function r(){n.removeEventListener(t,r,!1),e()},!1)},_.injectMethod=function(n,t,e){var r=n[t];n[t]=function(){var n=r.apply(this,arguments);return e.apply(this,arguments),n}},_.getCurrentPageUrl=function(){var n=getCurrentPages();if(n&&!(n.length<1))return n[n.length-1].route},_.getCurrentPageUrlWithArgs=function(){var n=getCurrentPages();if(n&&!(n.length<1)){var t=n[n.length-1],e=t.route,r=t.options,i=e+"?";for(var o in r){i+=o+"="+r[o]+"&"}return i=i.substring(0,i.length-1)}},_.logError=function(n){key_error in console&&console[key_error](key_gdt_pixel_error+": "+n)},_.logInfo=function(n){key_info in console&&console[key_info](key_gdt_pixel_warn+": "+n)},_.logWarning=function(n){key_warn in console&&console[key_warn](key_gdt_pixel_warn+": "+n)},_.JSONEncode=function(n){var t=function(n){var t=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return t.lastIndex=0,t.test(n)?'"'+n.replace(t,function(n){var t=e[n];return"string"==typeof t?t:"\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+n+'"'},e=function(n,r){var i="",o=0,a="",c="",u=0,s=i,f=[],l=r[n];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(n)),typeof l){case"string":return t(l);case"number":return isFinite(l)?String(l):"null";case"boolean":case"null":return String(l);case"object":if(!l)return"null";if(i+="",f=[],"[object Array]"===toString.apply(l)){for(u=l.length,o=0;o<u;o+=1)f[o]=e(o,l)||"null";return c=0===f.length?"[]":i?"[\n"+i+f.join(",\n"+i)+"\n"+s+"]":"["+f.join(",")+"]",i=s,c}for(a in l)hasOwnProperty.call(l,a)&&(c=e(a,l))&&f.push(t(a)+(i?": ":":")+c);return c=0===f.length?"{}":i?"{"+f.join(",")+s+"}":"{"+f.join(",")+"}",i=s,c}};return e("",{"":n})},_.JSONDecode=function(){var n,t,e,r,i={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},o=function(t){throw{name:"SyntaxError",message:t,at:n,text:e}},a=function(r){return r&&r!==t&&o("Expected '"+r+"' instead of '"+t+"'"),t=e.charAt(n),n+=1,t},c=function(){var n,e="";for("-"===t&&(e="-",a("-"));t>="0"&&t<="9";)e+=t,a();if("."===t)for(e+=".";a()&&t>="0"&&t<="9";)e+=t;if("e"===t||"E"===t)for(e+=t,a(),"-"!==t&&"+"!==t||(e+=t,a());t>="0"&&t<="9";)e+=t,a();if(n=+e,isFinite(n))return n;o("Bad number")},u=function(){var n,e,r,c="";if('"'===t)for(;a();){if('"'===t)return a(),c;if("\\"===t)if(a(),"u"===t){for(r=0,e=0;e<4&&(n=parseInt(a(),16),isFinite(n));e+=1)r=16*r+n;c+=String.fromCharCode(r)}else{if("string"!=typeof i[t])break;c+=i[t]}else c+=t}o("Bad string")},s=function(){for(;t&&t<=" ";)a()};return r=function(){switch(s(),t){case"{":return function(){var n,e={};if("{"===t){if(a("{"),s(),"}"===t)return a("}"),e;for(;t;){if(n=u(),s(),a(":"),Object.hasOwnProperty.call(e,n)&&o('Duplicate key "'+n+'"'),e[n]=r(),s(),"}"===t)return a("}"),e;a(","),s()}}o("Bad object")}();case"[":return function(){var n=[];if("["===t){if(a("["),s(),"]"===t)return a("]"),n;for(;t;){if(n.push(r()),s(),"]"===t)return a("]"),n;a(","),s()}}o("Bad array")}();case'"':return u();case"-":return c();default:return t>="0"&&t<="9"?c():function(){switch(t){case"t":return a("t"),a("r"),a("u"),a("e"),!0;case"f":return a("f"),a("a"),a("l"),a("s"),a("e"),!1;case"n":return a("n"),a("u"),a("l"),a("l"),null}o('Unexpected "'+t+'"')}()}},function(i){var a;return e=i,n=0,t=" ",a=r(),s(),t&&o("Syntax error"),a}}();var Validator=function(){function n(n,t){this.actionType=n,this.actionParam=t||{},this.error=null,this.warnings=[]}return n.prototype={validateActionType:function(){return/^[a-zA-Z][_a-zA-Z0-9]{0,254}$/.test(this.actionType)||this._error("actionType参数只能包含字母、数字和下划线，且只能以字母开头，长度不能超过255个字符！"),this},validateActionParam:function(){var n=/^[a-zA-Z][_a-zA-Z0-9]{0,254}$/,t=this;return _.each(this.actionParam,function(e,r){if(n.test(r)||t._error("ActionParams的key["+r+"]只能包含字母、数字和下划线，且只能以字母开头，长度不能超过255个字符！"),_.isString(e)||_.isNumber(e)||_.isBoolean(e)||_.isArray(e)||t._error("ActionParams的key["+r+"]的value只能为字符串、数字、布尔或者数组类型！"),_.isArray(e))for(var i=0,o=e.length;i<o;i++)_.isString(e[i])||_.isNumber(e[i])||_.isBoolean(e[i])||t._error("ActionParams的key["+r+"]包含的元素只能为字符串、数字或者布尔类型！")}),this},_error:function(n){return this.error=n,this}},{validateActionType:function(t,e){return new n(t,e).validateActionType()},validateActionParam:function(t,e){return new n(t,e).validateActionParam()}}}(),actionCgi="https://a.gdt.qq.com/mp",gdt={};function injectLifeCycle(n,t,e){if(n[t]){var r=n[t];n[t]=function(){r.apply(this,arguments),e.apply(this,arguments)}}else n[t]=e}function appLaunch(){}function appShow(){}function appHide(){}gdt.inited=!1,gdt._queue=[],gdt.userActionSetId="",gdt.wxAppId="",gdt._info={contextInfo:{},getSysInfo:function(){var n=this,t=this.contextInfo;wx.getSystemInfo({success:function(n){t.model=n.model,t.brand=n.brand,t.wx_version=n.version,t.platform=n.platform,t.sdk_version=n.SDKVersion,t.os=n.system.split(" ")[0],t.os_version=n.system.split(" ")[1]},complete:n.flushQueue})},flushQueue:function(){gdt.inited=!0,gdt._queue.length>0&&(_.each(gdt._queue,function(n){gdt._track.apply(gdt,_.toArray(n))}),gdt._queue=[])}},gdt._init=function(){this._info.getSysInfo()},gdt._buildRequest=function(n){var t={};t.lib_ver=LIB_MINI_PROGRAM.VERSION,t.lib_name=LIB_MINI_PROGRAM.NAME,t.user_action_set_id=this.userActionSetId,t.app_id=this.wxAppId,t.open_id=n.wechat_openid,t.action_type=n.actionType,t.is_webview=!1;var e=_.getCurrentPageUrl()||"";return _.isEmpty(e)||(t.path=_.getCurrentPageUrl()||""),_.has(n.actionParams,"outer_action_id")&&(t.outer_action_id=n.actionParams.outer_action_id,delete n.actionParams.outer_action_id),_.isEmpty(n.actionParams)||(t.action_param=n.actionParams),_.isEmpty(this._info.contextInfo)||(t.context=this._info.contextInfo),t},gdt._sendRequest=function(n,t,e){var r=0,i=(String(Math.random())+String(Math.random())+String(Math.random())).slice(2,15);if("GET"===t){var o=actionCgi+"?"+n+"&nc="+i;(a=function(){wx.request({url:o,method:"GET",success:function(n){e&&e(n.data)},fail:function(n){r<gdt.options.autoRetry?(_.logInfo("发送错误，重新发送请求"),r++,a()):e&&e(n)}})})()}else{var a;n._=i,(a=function(){wx.request({url:actionCgi,method:"POST",data:n,success:function(n){e&&e(n.data)},fail:function(n){r<gdt.options.autoRetry?(_.logInfo("发送错误，重新发送请求"),r++,a()):e&&e(n)}})})()}},gdt._track=function(n,t){if(gdt.inited){var e=Validator.validateActionType(n.actionType,n.actionParam);if(e.error)_.logError(e.error);else{if(e.warnings)for(var r=0,i=e.warnings.length;r<i;r++)_.logWarning(e.warnings[r]);var o=Validator.validateActionParam(n.actionType,n.actionParam);if(o.error)_.logError(o.error);else{if(o.warnings)for(var a=o.warnings.length;r<a;r++)_.logWarning(o.warnings[r]);var c=this._buildRequest(n),u=_.HTTPBuildQuery(c);2e3>(actionCgi+"?"+u).length?this._sendRequest(u,"GET",t):this._sendRequest(c,"POST",t)}}}else gdt._queue.push(arguments)},gdt.init=function(n,t,e){n?t?(this.userActionSetId=n,this.wxAppId=t,this.options=_.extend(CONFIG,e||{}),this._init()):_.logError("请传入正确的微信小程序AppID！（登录https://mp.weixin.qq.com，在菜单 “设置” - “开发设置”就可以看到小程序的AppID了。）"):_.logError("请传入正确的数据源ID！")},gdt.track=function(n,t,e){if(_.isEmpty(n))_.logError("请不要传入空的行为类型！");else if(_.has(t,"wechat_openid")){var r=t.wechat_openid||"";_.isEmpty(r)?_.logError("请不要传入空的wechat_openid！"):(delete t.wechat_openid,this._track({actionType:n,wechat_openid:r,actionParams:t},e))}else _.logError("请在actionParams参数中传入wechat_openid！")};var originApp=App;function pageLoad(){}function pageUnload(){}function pageShow(){}function pageHide(){}App=function(n){injectLifeCycle(n,"onLaunch",appLaunch),injectLifeCycle(n,"onShow",appShow),injectLifeCycle(n,"onHide",appHide),n.gdt=gdt,originApp(n)};var originPage=Page;Page=function(n){injectLifeCycle(n,"onLoad",pageLoad),injectLifeCycle(n,"onUnload",pageUnload),injectLifeCycle(n,"onShow",pageShow),injectLifeCycle(n,"onHide",pageHide),originPage(n)},module.exports=gdt;