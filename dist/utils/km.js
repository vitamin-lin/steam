"use strict";var devCofig=require("./kmConf.js"),kmConfig=devCofig||{},KMC={api_base:"https://datalink.kongming-inc.com/wxapp_track_php/public/index.php",prefix:"km_",version:"0.0.1"},_={trim:function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}},dateKey="st, d";_.formatDate=function(e){if(_.isEmptyObject(e))return!1;for(var r in e)if(dateKey.indexOf(r)>=0){var t=e[r];e[r]=Math.floor(t/1e3)}return e},_.base64_encode=function(e){for(var r,t,n,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,o=e.length,s="";a<o;){if(r=255&e.charCodeAt(a++),a==o){s+=i.charAt(r>>2),s+=i.charAt((3&r)<<4),s+="==";break}if(t=e.charCodeAt(a++),a==o){s+=i.charAt(r>>2),s+=i.charAt((3&r)<<4|(240&t)>>4),s+=i.charAt((15&t)<<2),s+="=";break}n=e.charCodeAt(a++),s+=i.charAt(r>>2),s+=i.charAt((3&r)<<4|(240&t)>>4),s+=i.charAt((15&t)<<2|(192&n)>>6),s+=i.charAt(63&n)}return s},_.b64EncodeUnicode=function(e){return _.base64_encode(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,r){return String.fromCharCode("0x"+r)}))},_.base64Encode=function(e){var r,t,n,i,a,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s=0,u=0,c="",f=[];if(!e)return e;e=_.utf8Encode(e);do{r=(a=e.charCodeAt(s++)<<16|e.charCodeAt(s++)<<8|e.charCodeAt(s++))>>18&63,t=a>>12&63,n=a>>6&63,i=63&a,f[u++]=o.charAt(r)+o.charAt(t)+o.charAt(n)+o.charAt(i)}while(s<e.length);switch(c=f.join(""),e.length%3){case 1:c=c.slice(0,-2)+"==";break;case 2:c=c.slice(0,-1)+"="}return c},_.utf8Encode=function(e){var r,t,n,i,a="";for(r=t=0,n=(e=(e+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")).length,i=0;i<n;i++){var o=e.charCodeAt(i),s=null;o<128?t++:s=o>127&&o<2048?String.fromCharCode(o>>6|192,63&o|128):String.fromCharCode(o>>12|224,o>>6&63|128,63&o|128),null!==s&&(t>r&&(a+=e.substring(r,t)),a+=s,r=t=i+1)}return t>r&&(a+=e.substring(r,e.length)),a},_.JSONEncode=function(e){var r=function(e){var r=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,t={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return r.lastIndex=0,r.test(e)?'"'+e.replace(r,function(e){var r=t[e];return"string"==typeof r?r:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'},t=function(e,n){var i="",a=0,o="",s="",u=0,c=i,f=[],p=n[e];switch(p&&"object"==typeof p&&"function"==typeof p.toJSON&&(p=p.toJSON(e)),typeof p){case"string":return r(p);case"number":return isFinite(p)?String(p):"null";case"boolean":case"null":return String(p);case"object":if(!p)return"null";if(i+="    ",f=[],"[object Array]"===toString.apply(p)){for(u=p.length,a=0;a<u;a+=1)f[a]=t(a,p)||"null";return s=0===f.length?"[]":i?"[\n"+i+f.join(",\n"+i)+"\n"+c+"]":"["+f.join(",")+"]",i=c,s}for(o in p)hasOwnProperty.call(p,o)&&(s=t(o,p))&&f.push(r(o)+(i?": ":":")+s);return s=0===f.length?"{}":i?"{"+f.join(",")+c+"}":"{"+f.join(",")+"}",i=c,s}};return t("",{"":e})},_.isArray=Array.isArray||function(e){return"[object Array]"===toString.call(e)},_.isObject=function(e){return e===Object(e)&&!_.isArray(e)},_.isEmptyObject=function(e){if(_.isObject(e)){for(var r in e)if(hasOwnProperty.call(e,r))return!1;return!0}return!1},_.isFormatString=function(e){if("[object String]"!=toString.call(e))return!1;var r=e.replace(/\s+/g,"_");return!/[~`!@/#+=\$%\^()&\*]+/g.test(r)},_.random=function(){return Math.random().toString(16).replace(".","")+""+Date.now()};var KMS={rq_c:0,al_c:0,as_c:0,ah_c:0},wxu={};function KM(e){this.app=e}wxu.getUUID=function(e){var r="";try{r=wx.getStorageSync(KMC.prefix+"uuid")}catch(e){r="uuid-getstoragesync"}if(!r){r=Math.random().toString(16).replace(".","")+""+Date.now();try{wx.setStorageSync(KMC.prefix+"uuid",r)}catch(e){wx.setStorageSync(KMC.prefix+"uuid","uuid-getstoragesync")}e[KMC.prefix+"is_first_open"]=!0}return r},wxu.getPagePath=function(){try{var e=getCurrentPages(),r="/";return 0<e.length&&(r=e.pop().__route__),r}catch(e){}},wxu.getPagePathDes=function(){if(!kmConfig&&!kmConfig.appName)return!1;var e=kmConfig.appName?kmConfig.appName:"小程序";if(!kmConfig.pageDes)return e;var r=wxu.getPagePath();if(_.isEmptyObject(kmConfig.pageDes))return e;var t=kmConfig.pageDes[r];return t&&""!==_.trim(t)?t:e},wxu.getSystemInfo=function(){var e=wx.getSystemInfoSync();return{ww:e.windowWidth,wh:e.windowHeight,sbh:e.statusBarHeight,lg:e.language,wxv:e.version,system:encodeURIComponent(e.system),pl:encodeURIComponent(e.platform),fss:e.fontSizeSetting,sdkv:e.SDKVersion}},wxu.getNetworkType=function(e){wx.getNetworkType({success:function(r){e(r.networkType)}})},wxu.getUserAgent=function(){var e=wxu.getSystemInfo();return wxu.getNetworkType(function(e){wx.setStorageSync(KMC.prefix+"nt",e)}),e.nt=wx.getStorageSync(KMC.prefix+"nt")||"4g",e},wxu.getCustomerInfo=function(){var e="";try{e=wx.getStorageSync(kmConfig.token)}catch(e){}if(!e)return!1;for(var r=e.split(","),t={},n=0;n<r.length;n++)t[r[n]]=wx.getStorageSync(KMC.prefix+r[n]);return!_.isEmptyObject(t)&&t},wxu.getAppBaseInfo=function(e){var r=wxu.getWXID(e),t=e[KMC.prefix+"refererPath"]?e[KMC.prefix+"refererPath"]:"first",n={token:kmConfig.token,uuid:wxu.getUUID(),st:Date.now(),v:KMC.version,openid:r.openid,unionid:r.unionid,pp:wxu.getPagePath(),rpp:t};e.scene&&(n.sceneId=e.scene),e.refer_share_user&&(n.rsu=e.refer_share_user),e&&(n.l_token=e[KMC.prefix+"life_token"]);var i=wxu.getPagePathDes();i&&(n.pageDes=i);var a=wxu.getCustomerInfo();return a=a&&!_.isEmptyObject(a)?Object.assign(a,n):n},wxu.getWXID=function(e){var r={openid:"",unionid:""},t=wxu.getUUID(e);if(e.oid&&""!=e.oid)r.openid=e.oid;else{var n;try{n=wx.getStorageSync(KMC.prefix+"oid"+t)}catch(e){}r.openid=n||""}if(e.uid&&""!=e.uid)r.unionid=e.uid;else{var i;try{i=wx.getStorageSync(KMC.prefix+"uid"+t)}catch(e){}r.unionid=i||""}return r},wxu.getServerSession=function(e){if(!e)return!1;if(void 0===e.header)return!1;var r=e.header;if(void 0===r["Set-Cookie"])return!1;for(var t=r["Set-Cookie"].split(";"),n=!1,i=0,a=t.length;i<a;i++)t[i].indexOf("track_session")>-1&&(n=t[i]);return!!n&&n.split("=")[1]},wxu.setLocalSession=function(e){if(!e)return!1;try{wx.setStorageSync(KMC.prefix+"session",e)}catch(e){}},wxu.getLocalSession=function(){var e;try{e=wx.getStorageSync(KMC.prefix+"session")}catch(e){}return e},wxu.getWxUserInfo=function(e){wx.getSetting&&wx.getSetting({success:function(r){r.authSetting["scope.userInfo"]&&wx.getUserInfo({withCredentials:!1,success:function(r){e(r)}})}})},wxu.sendRequest=function(e,r,t){void 0===arguments[1]&&(r="Post"),void 0===arguments[2]&&(t="data");var n=wxu.getLocalSession(),i=0;KMS.rq_c+=1,e.rq_c=KMS.rq_c,e.d=Date.now();var a=function(){var o=i?e:_.formatDate(e),s=_.JSONEncode(o),u=_.b64EncodeUnicode(s);wx.request({url:KMC.api_base+"/"+t,data:{data:u},header:{"content-type":"application/x-www-form-urlencoded",Cookie:"track_session="+(n||"")+";"},method:r,success:function(e){var r=wxu.getServerSession(e);r&&wxu.setLocalSession(r)},fail:function(){i<3&&(i++,e.rt=i,a())}})};a()},wxu.getShareInfoDetail=function(e,r,t){void 0!==wx.getShareInfo?wx.getShareInfo({shareTicket:r,success:function(e){wxu.sendShareTrack(t+"_share_Info",null,JSON.stringify(e))},fail:function(){wxu.sendShareTrack(t+"_share_Info",null,"error")}}):wxu.sendShareTrack(t+"_share_Info",null,"error")},wxu.sendShareTrack=function(e,r,t){var n=getApp(),i=wxu.getUserAgent(),a=wxu.getAppBaseInfo(n),o={et:"Share",en:e};t&&(o.s_arge=t),r&&(o=Object.assign(o,r));var s=Object.assign(o,i,a);wxu.sendRequest(s)},wxu.sendErrorTrack=function(e){var r=getApp(),t=wxu.getUserAgent(),n=wxu.getAppBaseInfo(r),i={et:"Error",err:e},a=Object.assign(i,t,n);wxu.sendRequest(a)},wxu.sendAppTrack=function(e,r){void 0===e[KMC.prefix+"timestamp"]&&(e[KMC.prefix+"timestamp"]=Date.now());var t=wxu.getUserAgent(),n=wxu.getAppBaseInfo(e),i={et:"App",en:r},a=Object.assign(t,i,n),o={lopt:e[KMC.prefix+"launchOpt"],st:e[KMC.prefix+"timestamp"],dr:e[KMC.prefix+"duration"],pc:e[KMC.prefix+"page_count"],fp:e[KMC.prefix+"first_page"],lp:e[KMC.prefix+"last_page"],ec:e[KMC.prefix+"error_count"]};"launch"===r?KMS.al_c+=1:"show"===r?KMS.as_c+=1:KMS.ah_c+=1,o.alc=KMS.al_c,o.asc=KMS.as_c,o.ahc=KMS.ah_c,e.page_share_count&&"number"==typeof e.page_share_count&&(o.sc=e.page_share_count),e[KMC.prefix+"is_first_open"]&&(o.ifo="true"),e[KMC.prefix+"src"]&&(o.sr=e[KMC.prefix+"src"]),e.refer_share_user&&(o.rsu=e.refer_share_user),o=Object.assign(o,a),wxu.sendRequest(o)},wxu.sendPageTrack=function(e,r,t){e[KMC.prefix+"first_page"]||(e[KMC.prefix+"first_page"]=r.__route__,r[KMC.prefix+"is_first_page"]=!0),e[KMC.prefix+"last_page"]=r.__route__;var n={et:"Page",st:Date.now(),en:t,sc:r.page_share_count,pc:e[KMC.prefix+"page_count"]};r[KMC.prefix+"page_duration"]&&(n.dr=r[KMC.prefix+"page_duration"]),r[KMC.prefix+"is_first_page"]&&(n.ifp="true"),r[KMC.prefix+"l_time"]&&(n.lt=r[KMC.prefix+"l_time"]),r[KMC.prefix+"page_args"]&&(n.ag=r[KMC.prefix+"page_args"]),e[KMC.prefix+"shareTicket"]&&(n.ginfo=e[KMC.prefix+"shareTicket"]),e[KMC.prefix+"src"]&&(n.sr=e[KMC.prefix+"src"]),e.refer_share_user&&(n.rsu=e.refer_share_user);var i=wxu.getUserAgent(),a=wxu.getAppBaseInfo(e),o=Object.assign(n,i,a);wxu.sendRequest(o)},wxu.sendCSTrack=function(e,r){var t=getApp(),n=wxu.getUserAgent(),i=wxu.getAppBaseInfo(t),a={et:"CS",en:e};r&&(a.args=r);var o=Object.assign(n,i,a);wxu.sendRequest(o)},KM.prototype.track=function(e,r){if(!_.isFormatString(e))return!1;if(_.isFormatString.length>=255)return!1;if("object"==typeof r){for(var t in r){if(!_.isFormatString(t))return!1;if(_.isObject(r[t]))return!1}wxu.sendCSTrack(e,JSON.stringify(r))}else if("string"==typeof r&&r.length<=255){if(_.isFormatString(r)){var n=String(r);(new Object)[n]=r,wxu.sendCSTrack(e,r)}}else wxu.sendCSTrack(e,!1)},KM.prototype.indentify=function(e,r){if(!_.isFormatString(e))return!1;var t=wx.getSystemInfoSync(),n=wxu.getUUID(),i={openid:e,uuid:n,token:kmConfig.token?kmConfig.token:"",pb:encodeURIComponent(t.brand),pm:encodeURIComponent(t.model),pr:t.pixelRatio,scw:t.screenWidth,sch:t.screenHeight};this.oid=e;try{wx.setStorageSync(KMC.prefix+"oid"+n,e),_.isFormatString(e)&&(wx.setStorageSync(KMC.prefix+"uid"+n,r),i.unionid=r,this.uid=r)}catch(e){}wxu.sendRequest(i,"Post","user_relations")},KM.prototype.register=function(e){if(_.isEmptyObject(e))return!1;var r=[];try{for(var t in e)wx.setStorageSync(KMC.prefix+""+t,e[t]),r.push(t)}catch(e){}try{wx.setStorageSync(kmConfig.token,r.join(","))}catch(e){}},function(){function e(e,r,t){if(e[r]){var n=e[r];e[r]=function(e){t.call(this,e,r),n.call(this,e)}}else e[r]=function(e){t.call(this,e,r)}}var r=function(e){this.km=new KM(this);var r=wxu.getUUID(this),t=wxu.getWXID(this);t.openid&&(this.oid=t.openid),t.unionid&&(this.uid=t.unionid),this[KMC.prefix+"uuid"]=r,this[KMC.prefix+"life_token"]=_.random(),this[KMC.prefix+"timestamp"]=Date.now(),this[KMC.prefix+"showtime"]=Date.now(),this[KMC.prefix+"duration"]=0;var n=this;n[KMC.prefix+"error_count"]=0,n[KMC.prefix+"page_count"]=1,n[KMC.prefix+"first_page"]=0,n[KMC.prefix+"launchOpt"]=void 0!==e?e:{},void 0!=e.scene&&(n.scene=e.scene);wxu.getWxUserInfo(function(e){var r="";try{r=wx.getStorageSync(KMC.prefix+"uuid")}catch(e){r="uuid-getstoragesync"}if(e.userInfo.uuid=r,void 0!=n[KMC.prefix+"launchOpt"]){var t=n[KMC.prefix+"launchOpt"];void 0!=typeof t.query&&void 0!==t.query.refer_share_user&&(e.userInfo.rsu=t.query.refer_share_user),e.userInfo.token=kmConfig.token?kmConfig.token:"",void 0!=typeof t.scene&&(e.userInfo.sceneId=t.scene)}wxu.sendRequest(e.userInfo,"Post","user")}),wxu.sendAppTrack(n,"launch")},t=function(){this[KMC.prefix+"timestamp"]=Date.now(),this[KMC.prefix+"duration"]+=Date.now()-this[KMC.prefix+"showtime"],wxu.sendAppTrack(this,"unLaunch")},n=function(e){this[KMC.prefix+"showtime"]=Date.now(),this[KMC.prefix+"timestamp"]=Date.now(),this[KMC.prefix+"launchOpt"]=void 0!==e?e:{};wxu.getUUID(this);void 0!==e&&(void 0!==e.shareTicket&&(wxu.getShareInfoDetail(this,e.shareTicket,"click"),this[KMC.prefix+"shareTicket"]=e.shareTicket),void 0!==e.query&&void 0!==e.query.refer_share_user&&(this.refer_share_user=e.query.refer_share_user),void 0!=typeof e.scene&&(this.scene=e.scene)),wxu.sendAppTrack(this,"show")},i=function(e,r){this[KMC.prefix+"timestamp"]=Date.now(),this[KMC.prefix+"is_first_open"]&&(this[KMC.prefix+"is_first_open"]=!1),this[KMC.prefix+"duration"]=Date.now()-this[KMC.prefix+"showtime"],wxu.sendAppTrack(this,"hide")},a=function(e){void 0===this.aldstat_error_count?this.aldstat_error_count=1:this.aldstat_error_count++,wxu.sendErrorTrack(JSON.stringify(e))},o=App;App=function(s){e(s,"onLaunch",r),e(s,"onUnlaunch",t),e(s,"onShow",n),e(s,"onHide",i),e(s,"onError",a),o(s)};var s=function(e){var r=getApp();_.isEmptyObject(e)||(void 0!==e.kmsrc&&(r[KMC.prefix+"src"]=e.kmsrc),void 0!==e.refer_share_user&&(r.refer_share_user=e.refer_share_user),this[KMC.prefix+"page_args"]=JSON.stringify(e));var t=wx.getStorageSync(KMC.prefix+"refererPath");t&&(r[KMC.prefix+"refererPath"]=t),r[KMC.prefix+"page_count"]?r[KMC.prefix+"page_count"]++:r[KMC.prefix+"page_count"]=1,this[KMC.prefix+"load_time"]=Date.now(),this[KMC.prefix+"start_time"]=Date.now(),wxu.sendPageTrack(r,this,"load")},u=function(){var e=this[KMC.prefix+"load_time"];e&&(this[KMC.prefix+"l_time"]=Date.now()-e)},c=function(){var e=getApp(),r=this[KMC.prefix+"start_time"];this[KMC.prefix+"page_duration"]=Date.now()-r;var t=this.__route__;wx.setStorageSync(KMC.prefix+"refererPath",t),wxu.sendPageTrack(e,this,"unload")},f=function(e,r){var t=getApp();this[KMC.prefix+"start_time"]=Date.now();var n=wx.getStorageSync(KMC.prefix+"refererPath");n&&(t[KMC.prefix+"refererPath"]=n),wxu.sendPageTrack(t,this,"show")},p=function(e,r){var t=getApp(),n=this[KMC.prefix+"start_time"];this[KMC.prefix+"page_duration"]=Date.now()-n;var i=this.__route__;wx.setStorageSync(KMC.prefix+"refererPath",i),wxu.sendPageTrack(t,this,"hide")},g=function(){},h=function(){},x=function(e,r){var t=getApp();if(void 0!==e&&void 0!==e[1]){var n="";try{n=wx.getStorageSync(KMC.prefix+"uuid")}catch(e){n="uuid-getstoragesync-error"}var i="",a=KMC.prefix+n+"USC";try{i=wx.getStorageSync(a)}catch(e){i="user_share_count_error"}if(""===i||void 0===i){try{wx.setStorageSync(a,1)}catch(e){}i=1,t.page_share_count=i}else{i=parseInt(wx.getStorageSync(a))+1,t.page_share_count=i;try{wx.setStorageSync(a,i)}catch(e){}}var o="";if("undefined"!==t.refer_share_user&&t.refer_share_user){for(var s=(o=t.refer_share_user).split(","),u=!1,c=0,f=s.length;c<f;c++){if(s[c].replace('"',"")==n){u=!0;break}}s.length>=3&&(u||s.shift(),o=s.toString()),""===o||u||(o=o+","+n)}else try{o=wx.getStorageSync(KMC.prefix+"uuid")}catch(e){o="refferer_share_user_error"}e[1].path&&"undefined"!==e[1].path||(KmConfig.defaultSharePath?e[1].path=KmConfig.defaultSharePath:e[1].path=this.__route__),-1!=e[1].path.indexOf("?")?e[1].path+="&refer_share_user="+o:e[1].path+="?refer_share_user="+o;var p={from:e[0].from,path:e[1].path,title:e[1].title,imageUrl:e[1].imageUrl};void 0===e[1].success&&(e[1].success=function(e){}),void 0===e[1].fail&&(e[1].fail=function(e){});var g=e[1].fail,h=e[1].success;return e[1].success=function(e){"object"==typeof e.shareTickets?p.shareType="ShareToGroup":p.shareType="ShareToFriend",wxu.sendShareTrack("share_status",p,JSON.stringify(e)),h(e)},e[1].fail=function(e){wxu.sendShareTrack("share_status",p,"fail"),g(e)},e[1]}},d=Page;Page=function(r){e(r,"onLoad",s),e(r,"onReady",u),e(r,"onUnload",c),e(r,"onShow",f),e(r,"onHide",p),e(r,"onReachBottom",g),e(r,"onPullDownRefresh",h),void 0!==r.onShareAppMessage&&function(e,r,t){if(e[r]){var n=e[r];e[r]=function(e){var i=n.call(this,e);return t.call(this,[e,i],r),i}}else e[r]=function(e){t.call(this,e,r)}}(r,"onShareAppMessage",x),d(r)}}();
